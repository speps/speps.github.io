<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>speps.fr - RÃ©mi Gillig - Torus Trooper - Rebooting a 15 year-old game written in D - Part 4 Final steps</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="/css/main.css"/>
    <link rel="stylesheet" type="text/css" href="/css/syntax.css"/>
    <link rel='shortcut icon' href='/favicon.ico' />
    <link rel='icon' href='/favicon.gif' type='image/gif'/>
</head>
<body>
    <div id="bg-container">
        <div id="bg">
            <div id="bg-right"></div>
        </div>
    </div>
    <div id="main-container">
        <div id="main">
            <div id="header">
                <h1><a href="/" title="Return to the first page">speps.fr</a></h1>
                <ul>
                    <li><a href="/aboutme" title="Some information about myself"><span class="left"></span><span class="mid">About Me</span><span class="right"></span></a></li>
                    <li><a href="/projects" title="My work, my projects, my hobbies"><span class="left"></span><span class="mid">Projects</span><span class="right"></span></a></li>
                    <li><a href="/articles" title="Some articles I wrote"><span class="left"></span><span class="mid">Articles</span><span class="right"></span></a></li>
                    <li><a href="/resume" title="My resume for your recruiting needs"><span class="left"></span><span class="mid">Resume</span><span class="right"></span></a></li>
                    <li><a href="/links" title="What I spend my time with on the web"><span class="left"></span><span class="mid">Links</span><span class="right"></span></a></li>
                </ul>
                <div id="social"><a href="http://www.linkedin.com/in/remigillig"><img src="/images/linkedin.png"/></a></div>
                <div id="social">&nbsp;</div>
                <div id="social"><a href="http://twitter.com/remigillig"><img src="/images/twitter.png"/></a></div>
            </div>
<div id="content">
	<div id="page">
		<h1>Torus Trooper - Rebooting a 15 year-old game written in D - Part 4 Final steps</h1>
		
		<div id="sideinfo">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#hooking-up-keyboard-input">Hooking up keyboard input</a></li>
    <li><a href="#fmodf">fmodf</a></li>
    <li><a href="#tackling-memory-allocation">Tackling memory allocation</a></li>
    <li><a href="#resizing-the-game">Resizing the game</a></li>
    <li><a href="#playing-audio">Playing audio</a></li>
    <li><a href="#fix-gamedraw-loop">Fix game/draw loop</a></li>
    <li><a href="#loading-screen">Loading screen</a></li>
    <li><a href="#saving-local-scoresreplays">Saving local scores/replays</a></li>
    <li><a href="#mobile-support">Mobile support</a>
      <ul>
        <li><a href="#fullscreen-mode">Fullscreen mode</a></li>
        <li><a href="#on-screen-controls">On screen controls</a></li>
      </ul>
    </li>
    <li><a href="#wrapping-up-the-series">Wrapping up the series</a></li>
  </ul>
</nav>
		</div>
		
		<p>See also</p>
<ul>
<li><a href="/articles/torus-trooper-part1">Part 1 - Compiling a new executable</a></li>
<li><a href="/articles/torus-trooper-part2">Part 2 - Running the game for the first time</a></li>
<li><a href="/articles/torus-trooper-part3">Part 3 - Porting to WebAssembly</a></li>
<li><a href="/articles/torus-trooper-part4">Part 4 - Final steps</a></li>
</ul>
<h2 id="hooking-up-keyboard-input">Hooking up keyboard input</h2>
<p>Remember the interface we made earlier:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-d" data-lang="d"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">InputBackend</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDirState</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getButtonState</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kt">bool</span> <span class="nf">getExitState</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kt">bool</span> <span class="nf">getPauseState</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here is the implementation for WebAssembly:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-d" data-lang="d"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InputBackendWASM</span> <span class="o">:</span> <span class="n">InputBackend</span> <span class="o">{</span>
  <span class="kt">uint</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">override</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>
    <span class="kn">import</span> <span class="nn">wasm</span><span class="o">;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">wasm</span><span class="o">.</span><span class="na">inputState</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">override</span> <span class="kt">int</span> <span class="nf">getDirState</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">override</span> <span class="kt">int</span> <span class="nf">getButtonState</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">override</span> <span class="kt">bool</span> <span class="nf">getExitState</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="o">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">override</span> <span class="kt">bool</span> <span class="nf">getPauseState</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="o">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Very simple, the good thing is that the original code already used masks for gameplay inputs. I just had to add another bit for exit and another one for pause.</p>
<p>From the JS side, we have <code>keydown</code>/<code>keyup</code> events that map the masks to the final value:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">maskInput</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">enable</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">masks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">ArrowUp</span><span class="o">:</span> <span class="mh">0x1</span><span class="p">,</span>
    <span class="nx">ArrowDown</span><span class="o">:</span> <span class="mh">0x2</span><span class="p">,</span>
    <span class="nx">ArrowLeft</span><span class="o">:</span> <span class="mh">0x4</span><span class="p">,</span>
    <span class="nx">ArrowRight</span><span class="o">:</span> <span class="mh">0x8</span><span class="p">,</span>
    <span class="nx">ControlLeft</span><span class="o">:</span> <span class="mh">0x10</span><span class="p">,</span>
    <span class="nx">ShiftLeft</span><span class="o">:</span> <span class="mh">0x20</span><span class="p">,</span>
    <span class="nx">Escape</span><span class="o">:</span> <span class="mh">0x40</span><span class="p">,</span>
    <span class="nx">KeyP</span><span class="o">:</span> <span class="mh">0x80</span>
  <span class="p">};</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="k">in</span> <span class="nx">masks</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">mask</span> <span class="o">=</span> <span class="nx">masks</span><span class="p">[</span><span class="nx">code</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">enable</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">inputState</span> <span class="o">|=</span> <span class="nx">mask</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">inputState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">mask</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;keydown&#34;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">defaultPrevented</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">maskInput</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="p">},</span> <span class="kc">true</span><span class="p">);</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;keyup&#34;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">defaultPrevented</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">maskInput</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>This works well enough, we can extend it later with more keys that map to the same input or make it customisable.</p>
<h2 id="fmodf">fmodf</h2>
<p>While doing the custom runtime, and because we&rsquo;re not using any C runtime stuff, it complained about an undefined <code>fmod</code> symbol at link time. It&rsquo;s a math function to compute the floating-point remainder of the operation x/y.</p>
<p>Unfortunately this doesn&rsquo;t have a JS <code>Math</code> equivalent like the other ones, but it works in JS with the <code>%</code> operator, so I just ended up using that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">wasm_fmodf</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">%</span> <span class="nx">y</span><span class="p">;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="tackling-memory-allocation">Tackling memory allocation</h2>
<p>In the title screen, I found that approximately every 4800 frame there was an increase of the WASM memory buffer. It came from a <code>Vector3</code> allocation in <code>createTorusShape</code> used to draw multiple parts of the menu. I solved this one by using the <a href="https://dlang.org/spec/attribute.html#scope"><code>scope</code> keyword in D</a>, it means the allocation is limited to the scope:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-d" data-lang="d"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createTorusShape</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">scope</span> <span class="n">Vector3</span> <span class="n">cp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="o">;</span>
  <span class="n">cp</span><span class="o">.</span><span class="na">z</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">scope</span> <span class="n">Vector3</span> <span class="n">ringOfs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, during gameplay there are class instances that will live beyond the scope of a method and will need cleaning up once ununsed (eg. bullets or enemies). Ideally, we&rsquo;d want the GC to take care of that for us but D doesn&rsquo;t really have a GC unless you use the <code>druntime</code> code. Best we can do do here is reuse memory as much as we can and identify which parts still need allocations.</p>
<p>This is an area that probably needs more attention as it currently leaks memory but it&rsquo;s still possible to play through the game multiple times before it&rsquo;s an issue. Help would be appreciated on a solution, possibly making a very basic GC would be good but an easier way would just be to make a pool of most things that can be reused (some classes already did that but only for game stuff).</p>
<h2 id="resizing-the-game">Resizing the game</h2>
<p>I did the whole series so far using a fixed resolution of 800 x 600 but all the code to support resizing is available so let&rsquo;s try to handle that correctly.</p>
<p>I exposed a D method to WASM that will be called whenever the game needs to be resized, that tells the game what size the GL viewport is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">onResize</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">w</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">h</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">w</span> <span class="o">/</span> <span class="nx">ratio</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">w</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">h</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;px&#34;</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;px&#34;</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">w</span> <span class="o">+</span> <span class="s2">&#34;px&#34;</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">h</span> <span class="o">+</span> <span class="s2">&#34;px&#34;</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">w</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">h</span><span class="p">;</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">_resized</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
<span class="p">}</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;resize&#34;</span><span class="p">,</span> <span class="nx">onResize</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>That allows the game to retain its original 4:3 ratio. I found using a wider viewport results in camera issues that I&rsquo;m not willing to fix at this point, it also stretches the text and doesn&rsquo;t look as good.</p>
<h2 id="playing-audio">Playing audio</h2>
<p>Playing music and sound effects is an important part of the game&rsquo;s character. However, supporting SDL_Mixer in WebAssembly wasn&rsquo;t realistic. The best solution I found is to embed the sound files as <code>ubyte[]</code> and create bridge between JS and WASM that then uses the WebAudio API to play sounds.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-d" data-lang="d"><span class="kt">ubyte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">(</span><span class="kt">string</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/boss_dest.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/boss_dest.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/charge.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/charge.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/charge_shot.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/charge_shot.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/extend.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/extend.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/hit.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/hit.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/middle_dest.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/middle_dest.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/myship_dest.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/myship_dest.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/shot.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/shot.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/small_dest.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/small_dest.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/chunks/timeup_beep.wav&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/chunks/timeup_beep.wav&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/musics/tt1.ogg&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/musics/tt1.ogg&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/musics/tt2.ogg&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/musics/tt2.ogg&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/musics/tt3.ogg&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/musics/tt3.ogg&#34;</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="s">&#34;sounds/musics/tt4.ogg&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="k">cast</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">[])</span> <span class="n">import</span><span class="o">(</span><span class="s">&#34;sounds/musics/tt4.ogg&#34;</span><span class="o">);</span>
  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then we add a few new WASM exposed methods:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-d" data-lang="d"><span class="n">extern</span> <span class="o">(</span><span class="n">C</span><span class="o">)</span> <span class="o">{</span>
  <span class="kt">uint</span> <span class="nf">wasm_sound_load</span><span class="o">(</span><span class="kd">const</span><span class="o">(</span><span class="kt">char</span><span class="o">*)</span> <span class="n">nameptr</span><span class="o">,</span> <span class="n">size_t</span> <span class="n">namelen</span><span class="o">,</span> <span class="kd">const</span><span class="o">(</span><span class="kt">ubyte</span><span class="o">*)</span> <span class="n">bufptr</span><span class="o">,</span> <span class="n">size_t</span> <span class="n">buflen</span><span class="o">);</span>
  <span class="kt">void</span> <span class="nf">wasm_sound_play</span><span class="o">(</span><span class="kd">const</span><span class="o">(</span><span class="kt">char</span><span class="o">*)</span> <span class="n">nameptr</span><span class="o">,</span> <span class="n">size_t</span> <span class="n">namelen</span><span class="o">);</span>
  <span class="kt">void</span> <span class="nf">wasm_sound_fadeMusic</span><span class="o">(</span><span class="kt">uint</span> <span class="n">ms</span><span class="o">);</span>
  <span class="kt">void</span> <span class="nf">wasm_sound_haltMusic</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The main trick here was to make sure of 2 things:</p>
<ol>
<li>We can play the same sound effect multiple times in a row</li>
<li>The music system needs to behave the same way as SDL_Mixer: only one music at once an, in a loop, and some way to fade before the next music is played</li>
</ol>
<p>For 1, I found some StackOverflow answers that weren&rsquo;t satisfying until I discovered that <code>AudioContext.createBufferSource</code> can just be called every time we need to play a sound and we only need the <code>AudioBuffer</code> instances for each sound to be preloaded.</p>
<p>For 2, we can reuse the same flow for preloading but we also need to connect a <code>GainNode</code> to control the volume and store the sound instance so we can stop it when the next music starts. Conveniently, the <code>gain</code> property is an <code>AudioParam</code> instance which has a <code>linearRampToValueAtTime</code> method which we&rsquo;ll use to fade out the music.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">    <span class="c1">// ...
</span><span class="c1"></span>    <span class="nx">wasm_sound_play</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nameptr</span><span class="p">,</span> <span class="nx">namelen</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">nameptr</span><span class="p">,</span> <span class="nx">namelen</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">isMusic</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;sounds/musics&#34;</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">createBufferSource</span><span class="p">();</span>
      <span class="nx">src</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">acData</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isMusic</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">acMusic</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">acMusic</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
          <span class="nx">acMusic</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
          <span class="nx">acMusic</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kr">const</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">createGain</span><span class="p">();</span>
        <span class="nx">src</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
        <span class="nx">src</span><span class="p">.</span><span class="nx">loop</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">ac</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
        <span class="nx">acMusic</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">node</span><span class="o">:</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">gain</span><span class="o">:</span> <span class="nx">gain</span> <span class="p">};</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">src</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">ac</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">src</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">wasm_sound_fadeMusic</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">acMusic</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">acMusic</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">linearRampToValueAtTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="nx">ms</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1">// ...
</span></code></pre></td></tr></table>
</div>
</div><h2 id="fix-gamedraw-loop">Fix game/draw loop</h2>
<p>On platforms where the game runs a bit slower, it looks a bit jarring as the whole gameplay slows down to a crawl. The usual way I fix this is by using the method from <a href="https://gafferongames.com/post/fix_your_timestep/">Glenn Fiedler</a>. It&rsquo;s similar to what the original game did but original had a sleep timer which isn&rsquo;t very practical and doesn&rsquo;t really accomodate for slow platforms.</p>
<p>The big change is splitting the update loop from the draw method. We can even do the game loop in JS to avoid having to pass frame times back and forth across the JS/WASM boundary.</p>
<p>It looks something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">targetFrameRate</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">frameAccumulator</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">previousTimestamp</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">loop</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">previousTimestamp</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">previousTimestamp</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">timestamp</span> <span class="o">-</span> <span class="nx">previousTimestamp</span><span class="p">;</span>
    <span class="nx">previousTimestamp</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">;</span>
    <span class="nx">frameAccumulator</span> <span class="o">+=</span> <span class="nx">diff</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">numUpdates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">frameAccumulator</span> <span class="o">&gt;=</span> <span class="nx">targetFrameRate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">frameAccumulator</span> <span class="o">-=</span> <span class="nx">targetFrameRate</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exports</span><span class="p">.</span><span class="nx">_update</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">numUpdates</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">numUpdates</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">_draw</span><span class="p">();</span>
    <span class="nx">numUpdates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">loop</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="loading-screen">Loading screen</h2>
<p>With adding the audio, the transfer of <code>tt.wasm</code> is becoming a problem on first visit (it&rsquo;s cached afterwards). Before embedding the audio, the automatic compression in HTTP was doing an amazing job. However, with <code>.ogg</code> files it&rsquo;s not as efficient as those are already compressed. At the time of writing, it&rsquo;s a 5.49 MB transferred for a 7.66 MB total file size once decompressed. We&rsquo;ll need to find a solution and show a progress bar during loading.</p>
<p>For this, I had the idea of using an embedded SVG document inside the index page to avoid multiple transfers and have a way of displaying the controls while it&rsquo;s loading. To get the SVG, I did a debug output of some of the vector art from the game into a SVG path syntax (for <code>d</code> attribute of a <code>path</code> element) and included that into the index page. That means the title is now visible even before we finish loading the WASM binary.</p>
<p>With this, because all the static content is included in the index page, we can still show something if JavaScript is disabled. Then, if it&rsquo;s enabled, we can test for browser features we need and for optional ones. A message is displayed accordingly.</p>
<p>If everything works, we can use the Fetch API to have an accurate progress bar of how the WASM download is doing. If compression is enabled server side the <code>Content-Length</code> header from the HTTP request isn&rsquo;t accurate is it&rsquo;s the compressed size. The solution I used here is to hardcode the WASM size in the JS code as it&rsquo;s unlikely to change drastically anyway.</p>
<video controls src="/media/articles/tt_loading.mp4"></video>
<h2 id="saving-local-scoresreplays">Saving local scores/replays</h2>
<h2 id="mobile-support">Mobile support</h2>
<h3 id="fullscreen-mode">Fullscreen mode</h3>
<h3 id="on-screen-controls">On screen controls</h3>
<h2 id="wrapping-up-the-series">Wrapping up the series</h2>

	</div>
</div>
            <div id="footer"><p>2020-12-01 20:23:48 UTC - I speak for myself, I am not affiliated with any company - All rights reserved</p></div>
        </div>
    </div>
</body>
</html>